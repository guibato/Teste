{% extends 'imoveis/base.html' %}
{% block content %}

{% if form.ativo.errors %}
    <div class="alert alert-danger">
        {{ form.ativo.errors }}
    </div>
{% endif %}

<div class="container mx-auto p-4">
    <h2 class="text-2xl font-bold text-gray-100 mb-6">Cadastro de Contrato</h2>
    <form method="post" class="max-w-6xl mx-auto" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="flex flex-wrap gap-4">
            <div class="mb-4 ">
                <label for="ativo" class="block text-sm font-medium text-gray-300">Ativo?</label>
                {{ form.ativo }}
            </div>
            
            <div class="mb-4">
                <label for="tipo_contrato" class="block text-sm font-medium text-gray-300">Contrato</label>
                {{ form.tipo_contrato }}
            </div>

            <div class="mb-4">
                <label for="proprietario" class="block text-sm font-medium text-gray-300">Proprietário</label>
                {{ form.proprietario }}
            </div>

            <div class="mb-4">
                <label for="inquilino" class="block text-sm font-medium text-gray-300">Inquilino</label>
                {{ form.inquilino }}
            </div>

            <div class="mb-4">
                <label for="imovel" class="block text-sm font-medium text-gray-300">Imóvel</label>
                {{ form.imovel }}
            </div>

            <div class="mb-4 block text-sm font-medium text-gray-300">
                <label for="data_inicio" >Data de Início</label>
                <br>
                <input type="date" name="data_inicio" required>
            </div>

            <div class="mb-4 block text-sm font-medium text-gray-300">
                <label for="data_fim">Data de Fim</label>
                <br>
                <input type="date" name="data_fim" required>
            </div>

            <div class="mb-4 block text-sm font-medium text-gray-300">
                <label for="carencia">Carência</label>
                <br>
                <input type="number" name="carencia" value="0" required>
            </div>

            <div class="mb-4 block text-sm font-medium text-gray-300">
                <label for="fator_reajuste">Reajuste</label>
                <br>
                {{ form.fator_reajuste }}
            </div>

            <div class="mb-4 block text-sm font-medium text-gray-300">
                <label for="multa_contratual">Multa Contratual</label>
                <br>
                {{ form.multa_contratual }}
            </div>

            <div class="mb-4">
                <label for="tipo_pagamento" class="block text-sm font-medium text-gray-300">Tipo de Aluguel</label>
                {{ form.tipo_pagamento }}
            </div>
            
            <!-- Valor do Aluguel -->
            <div id="valor_aluguel" class="mb-4 optional-field">
                <label for="valor_aluguel" class="block text-sm font-medium text-gray-300">Valor do Aluguel</label>
                <input type="number" step="0.01" name="valor_aluguel" id="valor_aluguel" class="currency-input">
            </div>
            
            <!-- Valor do Pacote -->
            <div id="valor_pacote" class="mb-4 optional-field">
                <label for="valor_pacote" class="block text-sm font-medium text-gray-300">Valor do Pacote</label>
                <input type="number" step="0.01" name="valor_pacote" id="valor_pacote" class="currency-input">
            </div>
            
            <!-- Condomínio -->
            <div id="valor_condominio" class="mb-4 optional-field">
                <label for="valor_condominio" class="block text-sm font-medium text-gray-300">Condomínio</label>
                <input type="number" step="0.01" name="valor_condominio" id="valor_condominio" class="currency-input">
            </div>
            
            <!-- IPTU -->
            <div id="valor_iptu" class="mb-4 optional-field">
                <label for="valor_iptu" class="block text-sm font-medium text-gray-300">IPTU</label>
                <input type="number" step="0.01" id="id_valor_iptu" name="valor_iptu" value="{{ form.valor_iptu.value|default_if_none:'' }}">            </div>
            
            <!-- Outros -->
            <div id="valor_outros" class="mb-4 optional-field">
                <label for="valor_outros" class="block text-sm font-medium text-gray-300">Outros</label>
                <input type="number" step="0.01" name="valor_outros" id="valor_outros" class="currency-input">
            </div>

            <div class="mb-4">
                <label for="tipo_taxa" class="block text-sm font-medium text-gray-300">Tipo de Taxa</label>
                {{ form.tipo_taxa }}
            </div>
            
            <!-- Valor da Taxa de Administração -->
            <div id="valor_taxa_administracao_percentual" class="mb-4 optional-field">
                <label for="valor_taxa_administracao_percentual" class="block text-sm font-medium text-gray-300">Administração - %</label>
                <input type="text" name="valor_taxa_administracao_percentual" id="valor_taxa_administracao_percentual" class="taxa-value" value="{{ form.valor_taxa_administracao_percentual.value }}">
            </div>

            <div id="valor_taxa_administracao_fixo" class="mb-4 optional-field">
                <label for="valor_taxa_administracao_fixo" class="block text-sm font-medium text-gray-300">Administração - R$</label>
                <input type="number" step="0.01" name="valor_taxa_administracao_fixo" id="valor_taxa_administracao_fixo" class="taxa-value" value="{{ form.valor_taxa_administracao_fixo.value }}">
            </div>

            <div class="mb-4">
                <label for="dia_pagamento" class="block text-sm font-medium text-gray-300">Dia de Pagamento</label>
                {{ form.dia_pagamento }}
            </div>
            
            <div class="mb-4">
                <label for="garantia" class="mb-4 text-sm font-medium text-gray-300">Garantia</label>
                <br>
                {{ form.garantia }}
            </div>

            <div id="fiador" class="mb-4 optional-field" style="display: none;">
                <label for="fiador" class="mb-4 text-sm font-medium text-gray-300">Fiador</label>
                <br>
                {{ form.fiador }}
            </div>

            <div id="valor_caucao" class="mb-4 optional-field" style="display: none;">
                <label for="valor_caucao">Valor Caução</label>
                <br>
                <input type="number" step="0.01" name="valor_caucao" id="valor_caucao" class="currency-input">
            </div>

            <div id="valor_segfi" class="mb-4 optional-field" style="display: none;">
                <label for="valor_segfi">Valor(R$)</label>
                <br>
                <input type="number" step="0.01" name="valor_segfi" id="valor_segfi" class="form-control">
            </div>

            <div id="apolice_segfi" class="mb-4 optional-field" style="display: none;">
                <label for="apolice_segfi">Apólice</label>
                <br>
                <input type="text" name="apolice_segfi" id="apolice_segfi" class="form-control">
            </div>
            <div id="seg_segfi" class="mb-4 optional-field" style="display: none;">
                <label for="seg_segfi">Seguradora</label>
                <br>
                <input type="text" name="seg_segfi" id="seg_segfi" class="form-control">
            </div>

            <div id="valor_cap" class="mb-4 optional-field" style="display: none;">
                <label for="valor_cap">Valor(R$)</label>
                <br>
                <input type="number" step="0.01" name="valor_cap" id="valor_cap" class="form-control">
            </div>

            <div id="apolice_cap" class="mb-4 optional-field" style="display: none;">
                <label for="apolice_cap">Apólice</label>
                <br>
                <input type="text" name="apolice_cap" id="apolice_cap" class="form-control">
            </div>
            <div id="seg_cap" class="mb-4 optional-field" style="display: none;">
                <label for="seg_cap">Seguradora</label>
                <br>
                <input type="text" name="seg_cap" id="seg_cap" class="form-control">
            </div>
            
            <div class="mb-4">
                <label for="clausula_12meses" class="mb-4 text-sm font-medium text-gray-300">Cláusula de 12 Meses?</label>
                <br>
                {{ form.clausula_12meses }}
            </div>
        </div>

        <h3 class="text-xl font-bold text-gray-100 mb-4">Seguro Contra Incêndio</h3>

        <div class="flex flex-wrap gap-4">

            <div class="mb-4">
                <label for="valor_seguro_incendio" class="mb-4 text-sm font-medium text-gray-300">Valor(R$)</label>
                <br>
                <input type="number" step="0.01" name="valor_seguro_incendio" id="valor_seguro_incendio" class="currency-input">
            </div>
            
            <div class="mb-4">
                <label for="seguradora_incendio" class=" mb-4 text-sm font-medium text-gray-300">Seguradora</label>
                <br>
                {{ form.seguradora_incendio }}
            </div>
            <div class="mb-4">
                <label for="apolice_incendio" class=" mb-4 text-sm font-medium text-gray-300">Apólice</label>
                <br>
                {{ form.apolice_incendio }}
            </div>

            

            <div class="mb-4">
                <label for="vencimento_seguro_incendio" class="mb-4 text-sm font-medium text-gray-300">Vencimento do Seguro</label>
                <br>
                <input type="date" name="vencimento_seguro_incendio">
            </div>

        </div>

        <h3 class="text-xl font-bold text-gray-100 mb-4">Documentos</h3>

        <div class="flex flex-wrap gap-4">
            <div class="mb-4">
                {{ form.documentos }}
                <p class="mt-1 text-sm text-gray-400">Aceita arquivos PDF, JPG ou PNG (máx. 5MB)</p>
            </div>
        </div>
        <button type="submit" class="w-full bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">Cadastrar</button>
    </form>

    {% if form.errors %}
    <div class="alert alert-danger">
        <ul>
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                <li>{{ field }}: {{ error }}</li>
            {% endfor %}
        {% endfor %}
        </ul>
    </div>
    {% endif %}

</div>

<script>
    const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                input.classList.add(
                    'bg-white',
                    'text-gray-900',
                    'p-2',
                    'rounded-lg',
                    'border',
                    'border-gray-300',
                    'focus:outline-none',
                    'focus:ring-2',
                    'focus:ring-blue-500'
                );
            });

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Seleciona os elementos relevantes
        const tipoPagamento = document.querySelector('#id_tipo_pagamento');
        const valorAluguelField = document.querySelector('#valor_aluguel');
        const valorPacoteField = document.querySelector('#valor_pacote');
        const condominioField = document.querySelector('#valor_condominio'); // Corrigido
        const iptuField = document.querySelector('#valor_iptu'); // Corrigido
        const outrosField = document.querySelector('#valor_outros'); // Corrigido
    
        // Função para atualizar a visibilidade dos campos
        function updateFieldVisibility() {
            if (tipoPagamento.value === 'Pacote') { // Verifica se a opção selecionada é "Pacote"
                valorAluguelField.style.display = 'none'; // Oculta o campo Valor do Aluguel
                condominioField.style.display = 'none';  // Oculta o campo Condomínio
                iptuField.style.display = 'none';        // Oculta o campo IPTU
                outrosField.style.display = 'none';      // Oculta o campo Outros
                valorPacoteField.style.display = 'block'; // Exibe o campo Valor do Pacote
            } else if (tipoPagamento.value === 'Despesas_Separadas') { // Verifica se a opção selecionada é "Despesas Separadas"
                valorAluguelField.style.display = 'block'; // Exibe o campo Valor do Aluguel
                condominioField.style.display = 'block';  // Exibe o campo Condomínio
                iptuField.style.display = 'block';        // Exibe o campo IPTU
                outrosField.style.display = 'block';      // Exibe o campo Outros
                valorPacoteField.style.display = 'none';  // Oculta o campo Valor do Pacote
            } else {
                // Caso nenhuma opção válida seja selecionada, oculta todos os campos
                valorAluguelField.style.display = 'none';
                condominioField.style.display = 'none';
                iptuField.style.display = 'none';
                outrosField.style.display = 'none';
                valorPacoteField.style.display = 'none';
            }
        }
    
        // Aplica a visibilidade inicial ao carregar a página
        updateFieldVisibility();
    
        // Atualiza a visibilidade quando o tipo de pagamento é alterado
        tipoPagamento.addEventListener('change', function () {
            updateFieldVisibility();
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    console.log('Script de garantia iniciado');

    const garantiaField = document.querySelector('#id_garantia');
    console.log('Campo garantia:', garantiaField);

    const fields = {
        fiador: document.querySelector('div#fiador'),
        valor_caucao: document.querySelector('div#valor_caucao'),
        valor_segfi: document.querySelector('div#valor_segfi'),
        apolice_segfi: document.querySelector('div#apolice_segfi'),
        seg_segfi: document.querySelector('div#seg_segfi'),
        valor_cap: document.querySelector('div#valor_cap'),
        apolice_cap: document.querySelector('div#apolice_cap'),
        seg_cap: document.querySelector('div#seg_cap')
    };

    console.log('Campos encontrados:', fields);

    function hideAllFields() {
        Object.entries(fields).forEach(([key, field]) => {
            if (field) {
                field.style.display = 'none';
                console.log(`Ocultando campo ${key}`);
            }
        });
    }

    function showFields(fieldIds) {
        fieldIds.forEach(id => {
            if (fields[id]) {
                fields[id].style.display = 'block';
                console.log(`Mostrando campo ${id}`);
            }
        });
    }

    function updateGarantiaVisibility() {
        const garantiaValue = garantiaField.value.toUpperCase();
        console.log('Valor da garantia selecionado:', garantiaValue);

        hideAllFields();

        // Usando valores em maiúsculo para comparação
        switch (garantiaValue) {
            case 'FIADOR':
                showFields(['fiador']);
                break;
            case 'CAUCAO':
            case 'CAUÇÃO': // Adicionando variação com acento
                showFields(['valor_caucao']);
                break;
            case 'SEGURO_FIANCA':
            case 'SEGURO FIANCA':
            case 'SEGURO_FIANÇA':
            case 'SEGURO FIANÇA': // Adicionando todas as variações possíveis
                showFields(['valor_segfi', 'apolice_segfi', 'seg_segfi']);
                break;
            case 'CAPITALIZACAO':
            case 'CAPITALIZAÇÃO':
                showFields(['valor_cap', 'apolice_cap', 'seg_cap']);
                break;
            default:
                console.log('Valor de garantia não reconhecido:', garantiaValue);
        }
    }

    if (garantiaField) {
        // Aplica a visibilidade inicial
        updateGarantiaVisibility();

        // Atualiza a visibilidade quando o tipo de garantia é alterado
        garantiaField.addEventListener('change', function() {
            console.log('Garantia alterada para:', this.value);
            updateGarantiaVisibility();
        });
        
        console.log('Listeners adicionados com sucesso');
    } else {
        console.error('Campo de garantia não encontrado!');
    }
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar valor em moeda brasileira
    function formatCurrency(value) {
        // Remove todos os caracteres não numéricos
        value = value.replace(/\D/g, '');
        
        // Converte para número e divide por 100 para trabalhar com centavos
        value = (parseInt(value) / 100).toFixed(2);
        
        // Formata o número para o padrão brasileiro
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }

    // Função para remover formatação
    function unformatCurrency(value) {
        // Remove R$, pontos, vírgulas e espaços
        return value.replace(/\D/g, '');
    }

    // Encontra todos os inputs do tipo number que representam moeda
    const currencyInputs = document.querySelectorAll('input[type="number"][step="0.01"]');
    
    currencyInputs.forEach(input => {
        // Cria um novo input text para mostrar o valor formatado
        const formattedInput = document.createElement('input');
        formattedInput.type = 'text';
        formattedInput.className = input.className;
        
        // Esconde o input original mas mantém ele no form
        input.style.display = 'none';
        input.parentNode.insertBefore(formattedInput, input);

        // Se já existir um valor, formata ele
        if (input.value) {
            const cents = Math.round(parseFloat(input.value) * 100);
            formattedInput.value = formatCurrency(cents.toString());
        }

        // Atualiza o input formatado quando o original mudar
        input.addEventListener('change', function() {
            const cents = Math.round(parseFloat(this.value) * 100);
            formattedInput.value = formatCurrency(cents.toString());
        });

        // Lida com a digitação no input formatado
        formattedInput.addEventListener('input', function(e) {
            let value = unformatCurrency(this.value);
            
            // Atualiza o input formatado
            this.value = formatCurrency(value);
            
            // Atualiza o input original com o valor sem formatação
            input.value = (parseInt(value) || 0) / 100;
        });

        // Quando o formulário for enviado, garante que o valor correto seja enviado
        input.form.addEventListener('submit', function() {
            const unformattedValue = unformatCurrency(formattedInput.value);
            input.value = (parseInt(unformattedValue) || 0) / 100;
        });
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Função para remover formatação de moeda
        function unformatCurrency(input) {
            input.value = input.value.replace(/\D/g, ''); // Remove tudo que não é número
        }
    
        // Remover formatação antes de enviar o formulário
        const form = document.querySelector('form');
        form.addEventListener('submit', function () {
            const currencyInputs = document.querySelectorAll('.currency-input');
            currencyInputs.forEach(input => {
                unformatCurrency(input);
            });
        });
    });
</script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
    // Seleciona os elementos relevantes
    const tipoTaxa = document.querySelector('#id_tipo_taxa'); // Campo "Tipo de Taxa"
    const taxaPercentualField = document.querySelector('#valor_taxa_administracao_percentual'); // Div do campo "Adm - %"
    const taxaFixoField = document.querySelector('#valor_taxa_administracao_fixo'); // Div do campo "Adm - R$"

    // Função para atualizar a visibilidade dos campos
    function updateTaxaVisibility() {
        if (tipoTaxa.value === 'percentual') { // Verifica se a opção selecionada é "Percentual (%)"
            taxaPercentualField.style.display = 'block'; // Exibe o campo "Adm - %"
            taxaFixoField.style.display = 'none';        // Oculta o campo "Adm - R$"
        } else if (tipoTaxa.value === 'fixo') {          // Verifica se a opção selecionada é "Fixo (R$)"
            taxaPercentualField.style.display = 'none';  // Oculta o campo "Adm - %"
            taxaFixoField.style.display = 'block';       // Exibe o campo "Adm - R$"
        } else {
            // Caso nenhuma opção válida seja selecionada, oculta todos os campos
            taxaPercentualField.style.display = 'none';
            taxaFixoField.style.display = 'none';
        }
    }

    // Aplica a visibilidade inicial ao carregar a página
    updateTaxaVisibility();

    // Atualiza a visibilidade quando o tipo de taxa é alterado
    tipoTaxa.addEventListener('change', function () {
        updateTaxaVisibility();
    });
});

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

{% endblock %}